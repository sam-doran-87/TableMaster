<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Encounter Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h2>RPG Encounter List</h2>

    <div class="action-controls">
        <div class="add-item-inputs">
            <input type="text" id="newItemText" placeholder="Character Name" autocomplete="off">
            <input type="number" id="newItemInitiative" placeholder="Initiative" autocomplete="off">
        </div>
        <div class="buttons-row">
            <button id="addItemButton">Add Character</button>
            <button id="sortInitiativeButton">Sort by Initiative</button>
        </div>
    </div>

    <ul id="sortable-list">
        <li data-initiative="18" data-current-hp="30" data-max-hp="30" data-status='{"Advantage":false,"Disadvantage":false,"Poisoned":false,"KO":false,"Dead":false}'>
            <span class="handle">⋮</span>
            <span class="item-text">Goblin Scout</span>
            <button class="edit-button">Edit</button>
            <span class="initiative-score">18</span>
            <button class="remove-button">X</button>
        </li>
        <li data-initiative="15" data-current-hp="25" data-max-hp="25" data-status='{"Advantage":false,"Disadvantage":false,"Poisoned":false,"KO":false,"Dead":false}'>
            <span class="handle">⋮</span>
            <span class="item-text">Orc Brute</span>
            <button class="edit-button">Edit</button>
            <span class="initiative-score">15</span>
            <button class="remove-button">X</button>
        </li>
        <li data-initiative="20" data-current-hp="10" data-max-hp="10" data-status='{"Advantage":false,"Disadvantage":false,"Poisoned":false,"KO":true,"Dead":false}'>
            <span class="handle">⋮</span>
            <span class="item-text">Dire Wolf</span>
            <button class="edit-button">Edit</button>
            <span class="initiative-score">20</span>
            <button class="remove-button">X</button>
        </li>
        <li data-initiative="12" data-current-hp="40" data-max-hp="40" data-status='{"Advantage":true,"Disadvantage":false,"Poisoned":false,"KO":false,"Dead":false}'>
            <span class="handle">⋮</span>
            <span class="item-text">Bandit Leader</span>
            <button class="edit-button">Edit</button>
            <span class="initiative-score">12</span>
            <button class="remove-button">X</button>
        </li>
    </ul>

    <div id="character-sheet">
        <h3 id="sheet-title">Selected Character</h3>
        <p><strong>HP:</strong> <span id="sheet-current-hp" class="editable-hp">--</span> / <span id="sheet-max-hp" class="editable-hp">--</span></p>
        <div class="status-section">
            <p><strong>Status:</strong></p>
            <label><input type="checkbox" class="status-checkbox" id="status-advantage"> Advantage</label>
            <label><input type="checkbox" class="status-checkbox" id="status-disadvantage"> Disadvantage</label>
            <label><input type="checkbox" class="status-checkbox" id="status-poisoned"> Poisoned</label>
            <label><input type="checkbox" class="status-checkbox" id="status-ko"> K.O.</label>
            <label><input type="checkbox" class="status-checkbox" id="status-dead"> Dead</label>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Get references to all necessary HTML elements
        const sortableList = document.getElementById('sortable-list');
        const newItemText = document.getElementById('newItemText');
        const newItemInitiative = document.getElementById('newItemInitiative');
        const addItemButton = document.getElementById('addItemButton');
        const sortInitiativeButton = document.getElementById('sortInitiativeButton');

        // Get references to character sheet elements
        const characterSheet = document.getElementById('character-sheet');
        const sheetTitle = document.getElementById('sheet-title');
        const sheetCurrentHp = document.getElementById('sheet-current-hp');
        const sheetMaxHp = document.getElementById('sheet-max-hp');
        const statusCheckboxes = document.querySelectorAll('.status-checkbox');


        // --- Initialize SortableJS ---
        const sortable = Sortable.create(sortableList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            handle: '.handle',
        });

        // --- Helper function to create a new list item HTML element ---
        function createListItemElement(nameText, initiativeValue, currentHp = 30, maxHp = 30, statusObj = null) {
            const listItem = document.createElement('li');
            listItem.setAttribute('data-initiative', initiativeValue);
            listItem.setAttribute('data-current-hp', currentHp);
            listItem.setAttribute('data-max-hp', maxHp);

            // Default status object if none provided
            if (statusObj === null) {
                statusObj = {
                    "Advantage": false,
                    "Disadvantage": false,
                    "Poisoned": false,
                    "KO": false,
                    "Dead": false
                };
            }
            listItem.setAttribute('data-status', JSON.stringify(statusObj));

            listItem.innerHTML = `
                <span class="handle">⋮</span>
                <span class="item-text">${nameText}</span>
                <button class="edit-button">Edit</button>
                <span class="initiative-score">${initiativeValue}</span>
                <button class="remove-button">X</button>
            `;
            return listItem;
        }

        // --- Function to Save the Current State to localStorage ---
        function saveState() {
            const items = [];
            sortableList.querySelectorAll('li').forEach(listItem => {
                const name = listItem.querySelector('.item-text').textContent;
                const initiative = listItem.querySelector('.initiative-score').textContent;
                const currentHp = listItem.getAttribute('data-current-hp');
                const maxHp = listItem.getAttribute('data-max-hp');
                const status = listItem.getAttribute('data-status'); // Already JSON string
                items.push({ name: name, initiative: initiative, currentHp: currentHp, maxHp: maxHp, status: status });
            });
            localStorage.setItem('rpgEncounterList', JSON.stringify(items));
            console.log('List state saved.');
        }

        // --- Function to Load the State from localStorage ---
        function loadState() {
            const savedList = localStorage.getItem('rpgEncounterList');
            if (savedList) {
                const items = JSON.parse(savedList);
                sortableList.innerHTML = ''; // Clear any default HTML items
                items.forEach(item => {
                    // Parse status string back to object before passing
                    const statusObj = item.status ? JSON.parse(item.status) : null;
                    const listItem = createListItemElement(item.name, item.initiative, item.currentHp, item.maxHp, statusObj);
                    sortableList.appendChild(listItem);
                });
                console.log('List state loaded.');
            } else {
                console.log('No saved list found. Initializing with default items.');
                // If no saved state, ensure the *currently existing HTML items* are correctly attributed and save them
                sortableList.querySelectorAll('li').forEach(listItem => {
                    if (!listItem.hasAttribute('data-current-hp')) listItem.setAttribute('data-current-hp', '30');
                    if (!listItem.hasAttribute('data-max-hp')) listItem.setAttribute('data-max-hp', '30');
                    if (!listItem.hasAttribute('data-status')) {
                        const defaultStatus = JSON.stringify({
                            "Advantage": false, "Disadvantage": false, "Poisoned": false, "KO": false, "Dead": false
                        });
                        listItem.setAttribute('data-status', defaultStatus);
                    }
                });
                saveState(); // Save this initial state to create a baseline
            }
        }


        // --- Function to Start Editing a Span ---
        function startEditingSpan(spanElement) {
            // Disable SortableJS ONLY if editing within the sortableList items
            if (spanElement.closest('#sortable-list')) {
                sortable.option('disabled', true);
            }

            spanElement.setAttribute('contenteditable', 'true');
            spanElement.focus();

            // Place cursor at the end of the text
            const range = document.createRange();
            range.selectNodeContents(spanElement);
            range.collapse(false); // Collapse to the end
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        // --- Function to Add a New List Item ---
        function addListItem() {
            const nameText = newItemText.value.trim();
            const initiativeValue = parseInt(newItemInitiative.value.trim(), 10) || 0;

            if (nameText) {
                const listItem = createListItemElement(nameText, initiativeValue, 30, 30);
                sortableList.appendChild(listItem);
                newItemText.value = '';
                newItemInitiative.value = '';
                newItemText.focus();
                saveState();
            }
        }

        // --- Event Listeners for Adding Items ---
        addItemButton.addEventListener('click', addListItem);
        newItemText.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') { addListItem(); }
        });
        newItemInitiative.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') { addListItem(); }
        });


        // --- Function to populate the character sheet ---
        function populateCharacterSheet(listItem) {
            if (!listItem) {
                clearCharacterSheet();
                return;
            }
            const name = listItem.querySelector('.item-text').textContent;
            const currentHp = listItem.getAttribute('data-current-hp');
            const maxHp = listItem.getAttribute('data-max-hp');
            const statusString = listItem.getAttribute('data-status');
            const statusObj = JSON.parse(statusString);

            sheetTitle.textContent = name;
            sheetCurrentHp.textContent = currentHp;
            sheetMaxHp.textContent = maxHp;
            characterSheet.style.display = 'block';

            // Set checkbox states based on statusObj
            statusCheckboxes.forEach(checkbox => {
                const statusKey = checkbox.id.replace('status-', '');
                if (statusObj.hasOwnProperty(statusKey)) {
                    checkbox.checked = statusObj[statusKey];
                } else {
                    checkbox.checked = false;
                }
            });
        }

        // --- Function to clear the character sheet ---
        function clearCharacterSheet() {
            sheetTitle.textContent = 'Selected Character';
            sheetCurrentHp.textContent = '--';
            sheetMaxHp.textContent = '--';
            statusCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
        }

        // --- CENTRALIZED Event Listener for List Item Clicks ---
        sortableList.addEventListener('click', function(event) {
            const clickedItem = event.target.closest('li');

            if (event.target.classList.contains('remove-button')) {
                if (clickedItem) {
                    sortableList.removeChild(clickedItem);
                    saveState();
                    if (clickedItem.classList.contains('highlighted')) {
                        clearCharacterSheet();
                    }
                }
                return;
            }

            if (event.target.classList.contains('edit-button')) {
                if (clickedItem) {
                    const itemTextSpan = clickedItem.querySelector('.item-text');
                    if (itemTextSpan) {
                        startEditingSpan(itemTextSpan);
                    }
                }
                return;
            }

            if (event.target.classList.contains('handle')) {
                return;
            }

            if (clickedItem) {
                sortableList.querySelectorAll('li').forEach(item => {
                    item.classList.remove('highlighted');
                });
                clickedItem.classList.add('highlighted');
                populateCharacterSheet(clickedItem);
            }
        });


        // --- Handle Editing Completion (on blur or Enter key) ---
        document.addEventListener('blur', function(event) {
            const targetElement = event.target;

            if (targetElement.getAttribute('contenteditable') === 'true' &&
                (targetElement.classList.contains('item-text') ||
                 targetElement.classList.contains('initiative-score') ||
                 targetElement.id === 'sheet-current-hp' ||
                 targetElement.id === 'sheet-max-hp'))
            {
                if (targetElement.closest('#sortable-list')) {
                    sortable.option('disabled', false);
                }

                targetElement.removeAttribute('contenteditable');

                let newContent = targetElement.textContent.trim();
                const listItem = targetElement.closest('li');
                const highlightedListItem = document.querySelector('.highlighted');

                if (targetElement.classList.contains('initiative-score')) {
                    let numValue = parseInt(newContent, 10);
                    if (isNaN(numValue)) { numValue = 0; }
                    targetElement.textContent = numValue;
                    if (listItem) { listItem.setAttribute('data-initiative', numValue); }
                } else if (targetElement.classList.contains('item-text')) {
                    targetElement.textContent = newContent;
                    if (targetElement.textContent === '') {
                        if (listItem) { sortableList.removeChild(listItem); }
                    }
                } else if (targetElement.id === 'sheet-current-hp') {
                    let numValue = parseInt(newContent, 10);
                    if (isNaN(numValue)) { numValue = 0; }
                    targetElement.textContent = numValue;
                    if (highlightedListItem) {
                        highlightedListItem.setAttribute('data-current-hp', numValue);
                    }
                } else if (targetElement.id === 'sheet-max-hp') {
                    let numValue = parseInt(newContent, 10);
                    if (isNaN(numValue)) { numValue = 0; }
                    targetElement.textContent = numValue;
                    if (highlightedListItem) {
                        highlightedListItem.setAttribute('data-max-hp', numValue);
                    }
                }

                saveState();
                if (highlightedListItem) {
                    populateCharacterSheet(highlightedListItem);
                }
            }
        }, true);

        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' &&
                event.target.getAttribute('contenteditable') === 'true' &&
                (event.target.classList.contains('item-text') ||
                 event.target.classList.contains('initiative-score') ||
                 event.target.id === 'sheet-current-hp' ||
                 event.target.id === 'sheet-max-hp'))
            {
                event.preventDefault();
                event.target.blur();
            }
        });


        // --- Event Listeners for Character Sheet HP Clicks to Start Editing ---
        sheetCurrentHp.addEventListener('click', function() {
            if (document.querySelector('.highlighted')) {
                startEditingSpan(sheetCurrentHp);
            }
        });

        sheetMaxHp.addEventListener('click', function() {
            if (document.querySelector('.highlighted')) {
                startEditingSpan(sheetMaxHp);
            }
        });

        // --- Event Listeners for Status Checkbox Changes ---
        statusCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const highlightedListItem = document.querySelector('.highlighted');
                if (highlightedListItem) {
                    const statusString = highlightedListItem.getAttribute('data-status');
                    let statusObj = JSON.parse(statusString);

                    const statusKey = this.id.replace('status-', '');

                    // Handle "K.O." and "Dead" exclusivity
                    if (statusKey === 'ko' && this.checked) {
                        statusObj.Dead = false;
                        document.getElementById('status-dead').checked = false;
                    } else if (statusKey === 'dead' && this.checked) {
                        statusObj.KO = false;
                        document.getElementById('status-ko').checked = false;
                    }

                    statusObj[statusKey] = this.checked;

                    highlightedListItem.setAttribute('data-status', JSON.stringify(statusObj));
                    saveState();
                }
            });
        });


        // --- Function to Sort the List by Initiative Score ---
        sortInitiativeButton.addEventListener('click', function() {
            const listItems = Array.from(sortableList.children);

            listItems.sort((a, b) => {
                const initiativeA = parseInt(a.getAttribute('data-initiative'), 10) || 0;
                const initiativeB = parseInt(b.getAttribute('data-initiative'), 10) || 0;
                return initiativeB - initiativeA;
            });

            listItems.forEach(item => {
                sortableList.appendChild(item);
            });
            saveState();
            const previouslySelected = document.querySelector('.highlighted');
            if (previouslySelected) {
                populateCharacterSheet(previouslySelected);
            }
        });


        // --- Clear highlight and sheet when clicking outside the list/sheet ---
        document.addEventListener('click', function(event) {
            const isClickInsideList = sortableList.contains(event.target);
            const isClickInsideSheet = characterSheet.contains(event.target);
            const isStatusCheckbox = event.target.classList.contains('status-checkbox');

            if (!isClickInsideList && !isClickInsideSheet && !isStatusCheckbox) {
                sortableList.querySelectorAll('li').forEach(item => {
                    item.classList.remove('highlighted');
                });
                clearCharacterSheet();
            }
        });


        // --- Load state when the page finishes loading ---
        window.addEventListener('load', () => {
            loadState();
            clearCharacterSheet();
            // Automatically select the first item if the list is not empty after loading
            const firstItem = sortableList.querySelector('li');
            if (firstItem) {
                firstItem.classList.add('highlighted');
                populateCharacterSheet(firstItem);
            }
        });
    </script>

</body>
</html>
