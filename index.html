<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TableMaster RPG Tracker</title>
    <!-- Importing Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Importing SortableJS for drag-and-drop functionality -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <!-- Linking the external CSS file -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* This is a simple fallback for the CSS file in case it is not loaded */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #f7fafc;
            margin: 0;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TableMaster RPG Tracker</h1>
        <div class="main-content">
            <!-- Encounter Tracker Card -->
            <div class="encounter-tracker-card">
                <h2>Encounter Tracker</h2>
                <div class="input-section">
                    <input type="text" id="itemName" placeholder="Name">
                    <input type="number" id="itemInitiative" placeholder="Initiative" value="" onfocus="this.value=''">
                    <input type="number" id="itemHP" placeholder="HP" value="" onfocus="this.value=''">
                    <button id="addItemButton"><i class="fas fa-plus"></i> Add</button>
                </div>
                <div class="turn-controls">
                    <div class="turn-round-info">
                        <span id="turnInfo">Turn: 0</span>
                        <span id="roundInfo">Round: 1</span>
                    </div>
                    <div class="turn-buttons">
                        <button id="sortButton" class="sort-button"><i class="fas fa-sort-numeric-down"></i> Sort</button>
                        <button id="nextTurnButton" class="turn-button"><i class="fas fa-step-forward"></i> Next Turn</button>
                        <button id="resetButton" class="reset-button"><i class="fas fa-undo"></i> Reset</button>
                    </div>
                </div>
                <ul id="sortableList" class="sortable-list">
                    <!-- List items will be added here dynamically -->
                </ul>
            </div>
            <!-- Character Sheet Card -->
            <div class="character-sheet-card">
                <h2>Character Sheet</h2>
                <div class="sheet-group">
                    <div class="sheet-section">
                        <div class="sheet-label">Name: <span id="sheetName"></span></div>
                        <div class="sheet-label">Initiative: <span id="sheetInitiative"></span></div>
                    </div>
                    <div class="sheet-section">
                        <div class="sheet-label">HP: <div class="number-control-group"><span id="sheetHP" class="editable-field" contenteditable="true"></span><button class="number-btn" onclick="updateHP(-1)">-</button><button class="number-btn" onclick="updateHP(1)">+</button></div></div>
                    </div>
                </div>
                <div class="modifier-section">
                    <div class="sheet-label">Modifiers:</div>
                    <div class="modifiers-list">
                        <!-- Modifiers will be added dynamically -->
                    </div>
                </div>
                <div class="status-section">
                    <div class="sheet-label">Status:</div>
                    <div class="status-list">
                        <!-- Statuses will be added dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Dice Roller Card -->
        <div class="dice-roller-card">
            <h2>Dice Roller</h2>
            <div class="dice-input-section">
                <input type="number" id="dice-count" value="1" min="1" max="100">
                <span class="dice-x">d</span>
                <select id="dice-type">
                    <option value="4">4</option>
                    <option value="6">6</option>
                    <option value="8">8</option>
                    <option value="10">10</option>
                    <option value="12">12</option>
                    <option value="20" selected>20</option>
                    <option value="100">100</option>
                </select>
                <button id="roll-dice-button">Roll!</button>
            </div>
            <div id="dice-output" class="dice-output">
                <p>Rolls: --</p>
                <p>Total: --</p>
            </div>
            <div class="dice-modifiers-section">
                <div class="modifier-input-group">
                    <label for="modifier">Modifier:</label>
                    <input type="number" id="modifier" value="0">
                </div>
                <div class="roll-type-group">
                    <input type="radio" id="roll-normal" name="roll-type" value="normal" checked>
                    <label for="roll-normal">Normal</label>
                    <input type="radio" id="roll-advantage" name="roll-type" value="advantage">
                    <label for="roll-advantage">Advantage</label>
                    <input type="radio" id="roll-disadvantage" name="roll-type" value="disadvantage">
                    <label for="roll-disadvantage">Disadvantage</label>
                </div>
                <div class="invert-d100-group">
                    <input type="checkbox" id="invert-for-roll-under">
                    <label for="invert-for-roll-under">Invert for Roll Under</label>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Modal for Alerts -->
    <div id="custom-modal-overlay" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <p id="modal-message">This is a custom alert message.</p>
            <div class="modal-buttons">
                <button id="modal-ok" class="modal-button modal-button-confirm">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Data structure to hold our items and a unique ID counter
        let items = [];
        let itemIdCounter = 0;
        let currentTurnIndex = 0;
        let currentRound = 1;

        // Get DOM elements
        const itemNameInput = document.getElementById('itemName');
        const itemInitiativeInput = document.getElementById('itemInitiative');
        const itemHPInput = document.getElementById('itemHP');
        const addItemButton = document.getElementById('addItemButton');
        const sortButton = document.getElementById('sortButton');
        const nextTurnButton = document.getElementById('nextTurnButton');
        const resetButton = document.getElementById('resetButton');
        const sortableList = document.getElementById('sortableList');
        const turnInfo = document.getElementById('turnInfo');
        const roundInfo = document.getElementById('roundInfo');

        // Dice Roller elements
        const diceCountInput = document.getElementById('dice-count');
        const diceTypeSelect = document.getElementById('dice-type');
        const rollDiceButton = document.getElementById('roll-dice-button');
        const diceOutput = document.getElementById('dice-output');
        const modifierInput = document.getElementById('modifier');
        const rollTypeNormal = document.getElementById('roll-normal');
        const rollTypeAdvantage = document.getElementById('roll-advantage');
        const rollTypeDisadvantage = document.getElementById('roll-disadvantage');
        // Renamed the checkbox ID for clarity
        const invertRollUnderCheckbox = document.getElementById('invert-for-roll-under');

        // Character Sheet elements
        const characterSheetCard = document.querySelector('.character-sheet-card');
        const sheetName = document.getElementById('sheetName');
        const sheetInitiative = document.getElementById('sheetInitiative');
        const sheetHP = document.getElementById('sheetHP');

        // Custom Modal elements
        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalMessage = document.getElementById('modal-message');
        const modalOkButton = document.getElementById('modal-ok');

        // Function to show a custom modal alert
        function showModal(message) {
            modalMessage.textContent = message;
            modalOverlay.style.display = 'flex';
        }

        // Event listener for the modal OK button
        modalOkButton.addEventListener('click', () => {
            modalOverlay.style.display = 'none';
        });

        // Function to create and render a list item
        function renderItem(item) {
            const li = document.createElement('li');
            li.setAttribute('data-id', item.id);

            // Drag handle
            const handle = document.createElement('i');
            handle.className = 'fas fa-grip-lines handle';

            // Lock button
            const lockButton = document.createElement('button');
            lockButton.className = `item-lock-button ${item.locked ? 'locked' : ''}`;
            const lockIcon = document.createElement('i');
            lockIcon.className = item.locked ? 'fas fa-lock' : 'fas fa-lock-open';
            lockButton.appendChild(lockIcon);

            // Name
            const itemText = document.createElement('span');
            itemText.className = 'item-text';
            itemText.textContent = item.name;

            // Status icons
            const statusIcons = document.createElement('div');
            statusIcons.className = 'status-icons';
            if (item.status === 'down') {
                const icon = document.createElement('i');
                icon.className = 'fas fa-skull';
                statusIcons.appendChild(icon);
            }

            // Initiative score
            const initiativeScore = document.createElement('span');
            initiativeScore.className = 'initiative-score';
            initiativeScore.textContent = item.initiative;

            // HP
            const itemHP = document.createElement('span');
            itemHP.className = 'list-item-hp';
            itemHP.textContent = `HP: ${item.hp}`;

            // Remove button
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-button';
            removeButton.textContent = 'Remove';

            // Append elements to list item
            li.appendChild(handle);
            li.appendChild(lockButton);
            li.appendChild(itemText);
            li.appendChild(statusIcons);
            li.appendChild(itemHP);
            li.appendChild(initiativeScore);
            li.appendChild(removeButton);

            // Event listeners for the item
            li.addEventListener('click', (e) => {
                if (e.target.closest('.remove-button') || e.target.closest('.item-lock-button')) {
                    // Clicks on remove or lock button are handled separately
                    return;
                }
                selectItem(item.id);
            });

            lockButton.addEventListener('click', () => toggleLock(item.id));
            removeButton.addEventListener('click', () => removeItem(item.id));

            return li;
        }

        // Function to add a new item to the list
        function addItem() {
            const name = itemNameInput.value.trim();
            const initiative = parseInt(itemInitiativeInput.value, 10);
            const hp = parseInt(itemHPInput.value, 10);

            if (!name) {
                showModal('Name is required.');
                return;
            }
            if (isNaN(initiative)) {
                showModal('Initiative must be a number.');
                return;
            }
            if (isNaN(hp)) {
                showModal('HP must be a number.');
                return;
            }

            const newItem = {
                id: itemIdCounter++,
                name,
                initiative,
                hp,
                maxHp: hp,
                status: 'normal',
                locked: false
            };

            items.push(newItem);
            renderList();

            // Clear inputs
            itemNameInput.value = '';
            itemInitiativeInput.value = '';
            itemHPInput.value = '';
            itemNameInput.focus();
        }

        // Function to remove an item from the list
        function removeItem(id) {
            const itemIndex = items.findIndex(item => item.id === id);
            if (itemIndex > -1) {
                items.splice(itemIndex, 1);
                // Adjust turn index if the removed item was before the current turn
                if (itemIndex < currentTurnIndex) {
                    currentTurnIndex--;
                }
                renderList();
            }
        }

        // Function to toggle the lock state of an item
        function toggleLock(id) {
            const item = items.find(i => i.id === id);
            if (item) {
                item.locked = !item.locked;
                renderList();
            }
        }

        // Function to select an item and display its details in the character sheet
        function selectItem(id) {
            const selectedItem = items.find(item => item.id === id);
            if (selectedItem) {
                characterSheetCard.style.display = 'flex';
                sheetName.textContent = selectedItem.name;
                sheetInitiative.textContent = selectedItem.initiative;
                sheetHP.textContent = selectedItem.hp;
                sheetHP.dataset.itemId = selectedItem.id;

                // Highlight the selected item in the list
                document.querySelectorAll('.sortable-list li').forEach(li => {
                    li.classList.remove('highlighted');
                    if (parseInt(li.dataset.id) === id) {
                        li.classList.add('highlighted');
                    }
                });
            }
        }

        // Function to update the HP of a selected character
        function updateHP(value) {
            const itemId = sheetHP.dataset.itemId;
            if (itemId) {
                const item = items.find(i => i.id === parseInt(itemId));
                if (item) {
                    item.hp += value;
                    if (item.hp <= 0) {
                        item.status = 'down';
                    } else {
                        item.status = 'normal';
                    }
                    sheetHP.textContent = item.hp;
                    renderList();
                }
            }
        });

        // Function to update HP directly from contenteditable span
        sheetHP.addEventListener('input', () => {
            const itemId = sheetHP.dataset.itemId;
            if (itemId) {
                const item = items.find(i => i.id === parseInt(itemId));
                if (item) {
                    const newHP = parseInt(sheetHP.textContent, 10);
                    if (!isNaN(newHP)) {
                        item.hp = newHP;
                        if (item.hp <= 0) {
                            item.status = 'down';
                        } else {
                            item.status = 'normal';
                        }
                        renderList();
                    }
                }
            }
        });

        // Function to render the entire list
        function renderList() {
            sortableList.innerHTML = '';
            items.forEach((item, index) => {
                const li = renderItem(item);
                if (index === currentTurnIndex) {
                    li.classList.add('highlighted');
                }
                sortableList.appendChild(li);
            });
            updateTurnInfo();
        }

        // Function to sort the list by initiative
        function sortList() {
            items.sort((a, b) => b.initiative - a.initiative);
            currentTurnIndex = 0;
            currentRound = 1;
            renderList();
        }

        // Function to advance the turn
        function nextTurn() {
            if (items.length === 0) {
                return;
            }
            // Move the current highlighted class
            const currentItem = document.querySelector('.sortable-list li.highlighted');
            if (currentItem) {
                currentItem.classList.remove('highlighted');
            }

            currentTurnIndex = (currentTurnIndex + 1) % items.length;

            if (currentTurnIndex === 0) {
                currentRound++;
            }

            // Highlight the new current item
            const nextItem = document.querySelector(`.sortable-list li[data-id="${items[currentTurnIndex].id}"]`);
            if (nextItem) {
                nextItem.classList.add('highlighted');
            }

            updateTurnInfo();
        }

        // Function to reset the tracker
        function resetTracker() {
            items = [];
            currentTurnIndex = 0;
            currentRound = 1;
            renderList();
        }

        // Function to update turn and round information display
        function updateTurnInfo() {
            turnInfo.textContent = `Turn: ${currentTurnIndex + 1}`;
            roundInfo.textContent = `Round: ${currentRound}`;
        }

        // Event listeners for the main buttons
        addItemButton.addEventListener('click', addItem);
        sortButton.addEventListener('click', sortList);
        nextTurnButton.addEventListener('click', nextTurn);
        resetButton.addEventListener('click', resetTracker);

        // Add item on Enter key press
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                if (document.activeElement === itemNameInput || document.activeElement === itemInitiativeInput || document.activeElement === itemHPInput) {
                    addItem();
                }
            }
        });

        // Initialize SortableJS
        new Sortable(sortableList, {
            handle: '.handle',
            animation: 150,
            onUpdate: function (evt) {
                // Reorder the items array to match the new DOM order
                const newOrder = Array.from(evt.from.children).map(li => parseInt(li.dataset.id));
                const reorderedItems = newOrder.map(id => items.find(item => item.id === id));
                items = reorderedItems;
                // Find the new index of the current turn item
                const currentItemId = items[currentTurnIndex].id;
                currentTurnIndex = items.findIndex(item => item.id === currentItemId);
                renderList();
            }
        });

        // DICE ROLLER LOGIC
        rollDiceButton.addEventListener('click', () => {
            const diceCount = parseInt(diceCountInput.value, 10);
            const diceType = parseInt(diceTypeSelect.value, 10);
            const modifier = parseInt(modifierInput.value, 10);
            const isAdvantage = rollTypeAdvantage.checked;
            const isDisadvantage = rollTypeDisadvantage.checked;
            // Use the new checkbox ID
            const invertRollUnder = invertRollUnderCheckbox.checked;

            if (isNaN(diceCount) || diceCount < 1) {
                showModal("Please enter a valid number of dice.");
                return;
            }

            let rolls = [];
            let total = 0;
            let droppedRoll = null;

            // Roll logic for Advantage/Disadvantage
            if (isAdvantage || isDisadvantage) {
                // For Advantage/Disadvantage, always roll two dice
                let roll1 = Math.floor(Math.random() * diceType) + 1;
                let roll2 = Math.floor(Math.random() * diceType) + 1;
                rolls.push(roll1, roll2);

                if (isAdvantage) {
                    total = Math.max(roll1, roll2);
                    droppedRoll = Math.min(roll1, roll2);
                } else { // Disadvantage
                    total = Math.min(roll1, roll2);
                    droppedRoll = Math.max(roll1, roll2);
                }
            } else { // Normal roll or multiple dice
                for (let i = 0; i < diceCount; i++) {
                    const roll = Math.floor(Math.random() * diceType) + 1;
                    rolls.push(roll);
                    total += roll;
                }
            }
            
            // Apply roll under logic
            if (invertRollUnder) {
                // For "roll under" we'll show the roll as a number to beat, and the modifier is applied to the roll
                // for display purposes. The core roll number itself is not inverted, but the display text can reflect the concept.
                // Let's just calculate the final total with the modifier.
                // The actual "roll under" check (roll <= stat) is assumed to be done by the user.
            }

            // Add modifier after all rolls are determined
            const finalTotal = total + modifier;

            let outputHtml = `<p>Rolls: ${rolls.join(', ')}</p>`;
            if (droppedRoll !== null) {
                outputHtml += `<p>Dropped: ${droppedRoll}</p>`;
            }
            if (modifier !== 0) {
                outputHtml += `<p>Modifier: ${modifier > 0 ? '+' : ''}${modifier}</p>`;
            }
            outputHtml += `<p>Total: ${finalTotal}</p>`;

            diceOutput.innerHTML = outputHtml;
        });

        // The original toggle function is no longer needed since the checkbox is always enabled
        // for all dice types as per your request.
    </script>
</body>
</html>
