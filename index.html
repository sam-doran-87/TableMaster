<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Encounter Manager</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <h2>RPG Encounter List</h2>

    <div class="action-controls">
        <div class="add-item-inputs">
            <input type="text" id="newItemText" placeholder="Character Name" autocomplete="off">
            <input type="number" id="newItemInitiative" placeholder="Initiative" autocomplete="off">
        </div>
        <div class="buttons-row">
            <button id="addItemButton">Add Character</button>
            <button id="sortInitiativeButton">Sort by Initiative</button>
        </div>
    </div>

    <ul id="sortable-list">
        </ul>
  <div class="reset-controls">
        <button id="resetListButton">Reset List</button>
    </div>
    <div id="character-sheet">
        <h3 id="sheet-title">Selected Character</h3>
        <p><strong>HP:</strong> <span id="sheet-current-hp" class="editable-hp">--</span> / <span id="sheet-max-hp" class="editable-hp">--</span></p>
        <div class="status-section">
            <p><strong>Status:</strong></p>
            <label><input type="checkbox" class="status-checkbox" id="status-advantage"> Advantage</label>
            <label><input type="checkbox" class="status-checkbox" id="status-disadvantage"> Disadvantage</label>
            <label><input type="checkbox" class="status-checkbox" id="status-poisoned"> Poisoned</label>
            <label><input type="checkbox" class="status-checkbox" id="status-ko"> K.O.</label>
            <label><input type="checkbox" class="status-checkbox" id="status-dead"> Dead</label>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Get references to all necessary HTML elements
        const sortableList = document.getElementById('sortable-list');
        const newItemText = document.getElementById('newItemText');
        const newItemInitiative = document.getElementById('newItemInitiative');
        const addItemButton = document.getElementById('addItemButton');
        const sortInitiativeButton = document.getElementById('sortInitiativeButton');

        // Get references to character sheet elements
        const characterSheet = document.getElementById('character-sheet');
        const sheetTitle = document.getElementById('sheet-title');
        const sheetCurrentHp = document.getElementById('sheet-current-hp');
        const sheetMaxHp = document.getElementById('sheet-max-hp');
        const statusCheckboxes = document.querySelectorAll('.status-checkbox');


        // --- Initialize SortableJS ---
        const sortable = Sortable.create(sortableList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            handle: '.handle',
        });

        // --- Helper function to create a new list item HTML element ---
        function createListItemElement(nameText, initiativeValue, currentHp = 30, maxHp = 30, statusObj = null) {
            const listItem = document.createElement('li');
            listItem.setAttribute('data-initiative', initiativeValue);
            listItem.setAttribute('data-current-hp', currentHp);
            listItem.setAttribute('data-max-hp', maxHp);

            if (statusObj === null) {
                statusObj = {
                    "Advantage": false,
                    "Disadvantage": false,
                    "Poisoned": false,
                    "KO": false,
                    "Dead": false
                };
            }
            listItem.setAttribute('data-status', JSON.stringify(statusObj));

            listItem.innerHTML = `
                <span class="handle">â‹®</span>
                <span class="item-text">${nameText}</span>
                <button class="edit-button">Edit</button>
                <span class="initiative-score">${initiativeValue}</span>
                <button class="remove-button">X</button>
            `;
            return listItem;
        }

        // --- Function to Save the Current State to localStorage ---
        function saveState() {
            const items = [];
            sortableList.querySelectorAll('li').forEach(listItem => {
                const name = listItem.querySelector('.item-text').textContent;
                const initiative = listItem.querySelector('.initiative-score').textContent;
                const currentHp = listItem.getAttribute('data-current-hp');
                const maxHp = listItem.getAttribute('data-max-hp');
                const status = listItem.getAttribute('data-status'); // Already JSON string
                items.push({ name: name, initiative: initiative, currentHp: currentHp, maxHp: maxHp, status: status });
            });
            localStorage.setItem('rpgEncounterList', JSON.stringify(items));
            console.log('List state saved.');
        }

        // --- Function to Load the State from localStorage ---
        function loadState() {
            const savedList = localStorage.getItem('rpgEncounterList');
            sortableList.innerHTML = ''; // Always clear current HTML to prevent duplicates

            if (savedList) {
                const items = JSON.parse(savedList);
                items.forEach(item => {
                    // Ensure status is parsed, or use a default if it's null/undefined
                    const statusObj = item.status ? JSON.parse(item.status) : null;
                    const listItem = createListItemElement(item.name, item.initiative, item.currentHp, item.maxHp, statusObj);
                    sortableList.appendChild(listItem);
                });
                console.log('List state loaded from localStorage.');
            } else {
                console.log('No saved list found. Populating with default items.');
                // Default items to create if localStorage is empty
                const defaultCharacters = [
                    { name: "Goblin Scout", initiative: 18, currentHp: 30, maxHp: 30, status: null },
                    { name: "Orc Brute", initiative: 15, currentHp: 25, maxHp: 25, status: null },
                    { name: "Dire Wolf", initiative: 20, currentHp: 10, maxHp: 10, status: { "Advantage": false, "Disadvantage": false, "Poisoned": false, "KO": true, "Dead": false } },
                    { name: "Bandit Leader", initiative: 12, currentHp: 40, maxHp: 40, status: { "Advantage": true, "Disadvantage": false, "Poisoned": false, "KO": false, "Dead": false } }
                ];
                defaultCharacters.forEach(char => {
                    const listItem = createListItemElement(char.name, char.initiative, char.currentHp, char.maxHp, char.status);
                    sortableList.appendChild(listItem);
                });
                saveState(); // Save these default items immediately
            }
        }


        // --- Function to Start Editing a Span ---
        function startEditingSpan(spanElement) {
            if (spanElement.closest('#sortable-list')) {
                sortable.option('disabled', true);
            }

            spanElement.setAttribute('contenteditable', 'true');
            spanElement.focus();

            const range = document.createRange();
            range.selectNodeContents(spanElement);
            range.collapse(false); // Collapse to the end
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        }

        // --- Function to Add a New List Item ---
        function addListItem() {
            const nameText = newItemText.value.trim();
            const initiativeValue = parseInt(newItemInitiative.value.trim(), 10) || 0;

            if (nameText) {
                const listItem = createListItemElement(nameText, initiativeValue, 30, 30);
                sortableList.appendChild(listItem);
                newItemText.value = '';
                newItemInitiative.value = '';
                newItemText.focus();
                saveState();
                // If this is the first item added, select it
                if (sortableList.children.length === 1) {
                    listItem.classList.add('highlighted');
                    populateCharacterSheet(listItem);
                }
            }
        }

        // --- Event Listeners for Adding Items ---
        addItemButton.addEventListener('click', addListItem);
        newItemText.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') { addListItem(); }
        });
        newItemInitiative.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') { addListItem(); }
        });


        // --- Function to populate the character sheet ---
        function populateCharacterSheet(listItem) {
            if (!listItem) {
                clearCharacterSheet();
                return;
            }
            const name = listItem.querySelector('.item-text').textContent;
            const currentHp = listItem.getAttribute('data-current-hp');
            const maxHp = listItem.getAttribute('data-max-hp');
            const statusString = listItem.getAttribute('data-status');

            let statusObj;
            try {
                statusObj = JSON.parse(statusString);
            } catch (e) {
                console.error("Error parsing status JSON for", name, ":", e);
                statusObj = {}; // Fallback to empty object on error
            }

            sheetTitle.textContent = name;
            sheetCurrentHp.textContent = currentHp;
            sheetMaxHp.textContent = maxHp;
            characterSheet.style.display = 'block'; // Ensure sheet is visible

            // Set checkbox states based on statusObj
            statusCheckboxes.forEach(checkbox => {
                const statusKey = checkbox.id.replace('status-', ''); // e.g., "advantage", "ko"
                // Handle case sensitivity or missing keys gracefully
                if (statusObj.hasOwnProperty(statusKey)) {
                    checkbox.checked = statusObj[statusKey];
                } else {
                    checkbox.checked = false; // Default to unchecked if key not found
                }
            });
        }

        // --- Function to clear the character sheet ---
        function clearCharacterSheet() {
            sheetTitle.textContent = 'Selected Character';
            sheetCurrentHp.textContent = '--';
            sheetMaxHp.textContent = '--';
            statusCheckboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            // You can optionally hide the sheet completely if no character is selected:
            // characterSheet.style.display = 'none';
        }

        // --- CENTRALIZED Event Listener for List Item Clicks ---
        sortableList.addEventListener('click', function(event) {
            const clickedItem = event.target.closest('li');

            if (event.target.classList.contains('remove-button')) {
                if (clickedItem) {
                    const wasHighlighted = clickedItem.classList.contains('highlighted');
                    sortableList.removeChild(clickedItem);
                    saveState();
                    if (wasHighlighted) {
                        // If the removed item was highlighted, try to highlight the next one or clear
                        const newFirstItem = sortableList.querySelector('li');
                        if (newFirstItem) {
                            newFirstItem.classList.add('highlighted');
                            populateCharacterSheet(newFirstItem);
                        } else {
                            clearCharacterSheet();
                        }
                    }
                }
                return;
            }

            if (event.target.classList.contains('edit-button')) {
                if (clickedItem) {
                    const itemTextSpan = clickedItem.querySelector('.item-text');
                    if (itemTextSpan) {
                        startEditingSpan(itemTextSpan);
                    }
                }
                return;
            }

            if (event.target.classList.contains('handle')) {
                return;
            }

            if (clickedItem) {
                // Only change highlight if a different item is clicked
                if (!clickedItem.classList.contains('highlighted')) {
                    sortableList.querySelectorAll('li').forEach(item => {
                        item.classList.remove('highlighted');
                    });
                    clickedItem.classList.add('highlighted');
                    populateCharacterSheet(clickedItem);
                }
            }
        });


        // --- Handle Editing Completion (on blur or Enter key) ---
        document.addEventListener('blur', function(event) {
            const targetElement = event.target;

            if (targetElement.getAttribute('contenteditable') === 'true' &&
                (targetElement.classList.contains('item-text') ||
                 targetElement.classList.contains('initiative-score') ||
                 targetElement.id === 'sheet-current-hp' ||
                 targetElement.id === 'sheet-max-hp'))
            {
                if (targetElement.closest('#sortable-list')) {
                    sortable.option('disabled', false);
                }

                targetElement.removeAttribute('contenteditable');

                let newContent = targetElement.textContent.trim();
                const listItem = targetElement.closest('li'); // For list items (name/initiative)
                const highlightedListItem = document.querySelector('.highlighted'); // For sheet HP

                if (targetElement.classList.contains('initiative-score')) {
                    let numValue = parseInt(newContent, 10);
                    if (isNaN(numValue)) { numValue = 0; }
                    targetElement.textContent = numValue;
                    if (listItem) { listItem.setAttribute('data-initiative', numValue); }
                } else if (targetElement.classList.contains('item-text')) {
                    targetElement.textContent = newContent;
                    if (targetElement.textContent === '') {
                        if (listItem) {
                            // If the edited name is empty, remove the item
                            const wasHighlighted = listItem.classList.contains('highlighted');
                            sortableList.removeChild(listItem);
                            if (wasHighlighted) {
                                const newFirstItem = sortableList.querySelector('li');
                                if (newFirstItem) {
                                    newFirstItem.classList.add('highlighted');
                                    populateCharacterSheet(newFirstItem);
                                } else {
                                    clearCharacterSheet();
                                }
                            }
                        }
                    }
                } else if (targetElement.id === 'sheet-current-hp') {
                    let numValue = parseInt(newContent, 10);
                    if (isNaN(numValue)) { numValue = 0; }
                    targetElement.textContent = numValue;
                    if (highlightedListItem) {
                        highlightedListItem.setAttribute('data-current-hp', numValue);
                    }
                } else if (targetElement.id === 'sheet-max-hp') {
                    let numValue = parseInt(newContent, 10);
                    if (isNaN(numValue)) { numValue = 0; }
                    targetElement.textContent = numValue;
                    if (highlightedListItem) {
                        highlightedListItem.setAttribute('data-max-hp', numValue);
                    }
                }

                saveState();
                // Re-populate the sheet if the edited item is the currently highlighted one
                // This ensures HP/Status are refreshed if an attribute changed
                if (highlightedListItem) {
                    populateCharacterSheet(highlightedListItem);
                }
            }
        }, true); // Use capture phase for blur event for reliability

        document.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' &&
                event.target.getAttribute('contenteditable') === 'true' &&
                (event.target.classList.contains('item-text') ||
                 event.target.classList.contains('initiative-score') ||
                 event.target.id === 'sheet-current-hp' ||
                 event.target.id === 'sheet-max-hp'))
            {
                event.preventDefault();
                event.target.blur();
            }
        });


        // --- Event Listeners for Character Sheet HP Clicks to Start Editing ---
        // Ensure that a character is selected before making HP editable
        sheetCurrentHp.addEventListener('click', function() {
            if (document.querySelector('.highlighted')) {
                startEditingSpan(sheetCurrentHp);
            }
        });

        sheetMaxHp.addEventListener('click', function() {
            if (document.querySelector('.highlighted')) {
                startEditingSpan(sheetMaxHp);
            }
        });

        // --- Event Listeners for Status Checkbox Changes ---
        statusCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const highlightedListItem = document.querySelector('.highlighted');
                if (highlightedListItem) {
                    const statusString = highlightedListItem.getAttribute('data-status');
                    let statusObj;
                    try {
                        statusObj = JSON.parse(statusString);
                    } catch (e) {
                        console.error("Error parsing status JSON on checkbox change:", e);
                        statusObj = {}; // Fallback
                    }

                    const statusKey = this.id.replace('status-', '');

                    // Handle "K.O." and "Dead" exclusivity
                    if (statusKey === 'ko' && this.checked) {
                        statusObj.Dead = false;
                        const deadCheckbox = document.getElementById('status-dead');
                        if (deadCheckbox) deadCheckbox.checked = false;
                    } else if (statusKey === 'dead' && this.checked) {
                        statusObj.KO = false;
                        const koCheckbox = document.getElementById('status-ko');
                        if (koCheckbox) koCheckbox.checked = false;
                    }

                    statusObj[statusKey] = this.checked;

                    highlightedListItem.setAttribute('data-status', JSON.stringify(statusObj));
                    saveState();
                    // Re-populate to ensure UI reflects exclusivity rules immediately
                    populateCharacterSheet(highlightedListItem);
                }
            });
        });


        // --- Function to Sort the List by Initiative Score ---
        sortInitiativeButton.addEventListener('click', function() {
            const listItems = Array.from(sortableList.children);
            const previouslySelectedName = document.querySelector('.highlighted .item-text')?.textContent;

            listItems.sort((a, b) => {
                const initiativeA = parseInt(a.getAttribute('data-initiative'), 10) || 0;
                const initiativeB = parseInt(b.getAttribute('data-initiative'), 10) || 0;
                return initiativeB - initiativeA;
            });

            listItems.forEach(item => {
                sortableList.appendChild(item);
            });
            saveState();

            // Re-highlight and re-populate if a character was selected before sort
            if (previouslySelectedName) {
                const newHighlightedItem = Array.from(sortableList.children).find(item =>
                    item.querySelector('.item-text').textContent === previouslySelectedName
                );
                if (newHighlightedItem) {
                    sortableList.querySelectorAll('li').forEach(item => item.classList.remove('highlighted'));
                    newHighlightedItem.classList.add('highlighted');
                    populateCharacterSheet(newHighlightedItem);
                } else {
                    clearCharacterSheet(); // In case the previously selected item was removed before sort
                }
            }
        });


        // --- Clear highlight and sheet when clicking outside the list/sheet ---
        document.addEventListener('click', function(event) {
            const isClickInsideList = sortableList.contains(event.target);
            const isClickInsideSheet = characterSheet.contains(event.target);
            const isStatusCheckbox = event.target.classList.contains('status-checkbox'); // Keep this check

            // Don't clear if click is inside list, inside sheet, or specifically on a status checkbox
            if (!isClickInsideList && !isClickInsideSheet && !isStatusCheckbox) {
                sortableList.querySelectorAll('li').forEach(item => {
                    item.classList.remove('highlighted');
                });
                clearCharacterSheet();
            }
        });


        // --- Load state and initialize sheet when the page finishes loading ---
        window.addEventListener('load', () => {
            loadState(); // Load existing data or initialize default list items

            // Automatically select and populate the sheet for the first item if the list is not empty
            const firstItem = sortableList.querySelector('li');
            if (firstItem) {
                firstItem.classList.add('highlighted');
                populateCharacterSheet(firstItem);
            } else {
                clearCharacterSheet(); // If list is empty, ensure sheet is clear
            }
        });
    </script>

</body>
</html>
