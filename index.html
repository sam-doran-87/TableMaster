<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Encounter Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <h2>RPG Encounter List</h2>

    <div class="main-content-wrapper">

        <div class="encounter-tracker-card card">
            <div class="action-controls">
                <div class="add-item-inputs">
                    <input type="text" id="newItemText" placeholder="Character Name" autocomplete="off">
                    <input type="number" id="newItemInitiative" placeholder="Initiative" autocomplete="off">
                </div>
                <div class="buttons-row">
                    <button id="addItemButton">Add Character</button>
                    <button id="sortInitiativeButton">Sort by Initiative</button>
                </div>
            </div>

            <hr class="list-separator"> <div class="turn-controls">
                <button id="prevTurnButton">Previous Turn</button>
                <button id="nextTurnButton">Next Turn</button>
                <div id="roundCounter">Round: 1</div>
            </div>

            <ul id="sortable-list">
                </ul>

            <hr class="list-separator"> <div class="reset-controls">
                <button id="resetListButton">Reset List</button>
                <button id="resetTurnButton">Reset Turns</button>
            </div>
        </div> <div id="character-sheet" class="card">
            <h3 id="sheet-title">Selected Character</h3>
            <p><strong>HP:</strong> <span id="sheet-current-hp" class="editable-hp">--</span> / <span id="sheet-max-hp" class="editable-hp">--</span></p>
            <p><strong>AC:</strong> <span id="sheet-ac" class="editable-stat">--</span></p>
            <p><strong>Speed:</strong> <span id="sheet-speed" class="editable-stat">--</span></p>

            <div class="status-section">
                <p><strong>Status:</strong></p>
                <label><input type="checkbox" class="status-checkbox" id="status-advantage"> Advantage</label>
                <label><input type="checkbox" class="status-checkbox" id="status-disadvantage"> Disadvantage</label>
                <label><input type="checkbox" class="status-checkbox" id="status-poisoned"> Poisoned</label>
                <label><input type="checkbox" class="status-checkbox" id="status-ko"> K.O.</label>
                <label><input type="checkbox" class="status-checkbox" id="status-dead"> Dead</label>
            </div>

            <div class="notes-section">
                <p><strong>Notes:</strong></p>
                <span id="sheet-notes" class="editable-notes" contenteditable="true" role="textbox">No notes.</span>
            </div>
        </div> </div> <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        // Get references to all necessary HTML elements
        const sortableList = document.getElementById('sortable-list');
        const newItemText = document.getElementById('newItemText');
        const newItemInitiative = document.getElementById('newItemInitiative');
        const addItemButton = document.getElementById('addItemButton');
        const sortInitiativeButton = document.getElementById('sortInitiativeButton');
        const resetListButton = document.getElementById('resetListButton');

        // New turn control references
        const prevTurnButton = document.getElementById('prevTurnButton');
        const nextTurnButton = document.getElementById('nextTurnButton');
        const roundCounter = document.getElementById('roundCounter');
        const resetTurnButton = document.getElementById('resetTurnButton');

        // Get references to character sheet elements
        const characterSheet = document.getElementById('character-sheet');
        const sheetTitle = document.getElementById('sheet-title');
        const sheetCurrentHp = document.getElementById('sheet-current-hp');
        const sheetMaxHp = document.getElementById('sheet-max-hp');
        const sheetAC = document.getElementById('sheet-ac');
        const sheetSpeed = document.getElementById('sheet-speed');
        const sheetNotes = document.getElementById('sheet-notes');
        const statusCheckboxes = document.querySelectorAll('.status-checkbox');

        let currentRound = 1;
        let highlightedIndex = -1;

        // --- Initialize SortableJS ---
        const sortable = Sortable.create(sortableList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            handle: '.handle',
            onEnd: function (evt) {
                saveState();
                const currentHighlighted = document.querySelector('.highlighted');
                if (currentHighlighted) {
                    highlightedIndex = Array.from(sortableList.children).indexOf(currentHighlighted);
                } else {
                    highlightedIndex = -1;
                }
            },
        });

        // --- Helper function to create a new list item HTML element ---
        function createListItemElement(nameText, initiativeValue, currentHp = 30, maxHp = 30, ac = 10, speed = '30ft', notes = 'No notes.', statusObj = null, locked = false) {
            const listItem = document.createElement('li');
            listItem.setAttribute('data-initiative', initiativeValue);
            listItem.setAttribute('data-current-hp', currentHp);
            listItem.setAttribute('data-max-hp', maxHp);
            listItem.setAttribute('data-ac', ac);
            listItem.setAttribute('data-speed', speed);
            listItem.setAttribute('data-notes', notes);
            listItem.setAttribute('data-name', nameText);

            if (locked) {
                listItem.classList.add('locked');
            }

            if (statusObj === null) {
                statusObj = {
                    "advantage": false,
                    "disadvantage": false,
                    "poisoned": false,
                    "ko": false,
                    "dead": false
                };
            }
            listItem.setAttribute('data-status', JSON.stringify(statusObj));

            // Updated innerHTML for new buttons/icons and directly editable text
            listItem.innerHTML = `
                <span class="handle"><i class="fa-solid fa-grip-lines-vertical"></i></span>
                <span class="initiative-score" contenteditable="true">${initiativeValue}</span>
                <span class="list-item-hp">HP: ${currentHp}</span>
                <span class="item-text" contenteditable="true">${nameText}</span>
                <button class="lock-button">
                    <i class="${locked ? 'fa-solid fa-lock' : 'fa-solid fa-lock-open'}"></i>
                </button>
                <button class="remove-button"><i class="fa-solid fa-xmark"></i></button>
            `;
            applyHpColor(listItem);
            return listItem;
        }

        // --- Helper function to apply HP color to list item ---
        function applyHpColor(listItem) {
            const currentHp = parseInt(listItem.getAttribute('data-current-hp'), 10);
            const maxHp = parseInt(listItem.getAttribute('data-max-hp'), 10);
            const hpSpan = listItem.querySelector('.list-item-hp');

            if (!hpSpan) return;

            hpSpan.classList.remove('hp-full', 'hp-mid', 'hp-low', 'hp-zero');

            if (currentHp <= 0) {
                hpSpan.classList.add('hp-zero');
            } else if (currentHp / maxHp <= 0.25) {
                hpSpan.classList.add('hp-low');
            } else if (currentHp / maxHp <= 0.75) {
                hpSpan.classList.add('hp-mid');
            } else {
                hpSpan.classList.add('hp-full');
            }
        }

        // --- Helper function to update the round counter display ---
        function updateRoundCounter() {
            roundCounter.textContent = `Round: ${currentRound}`;
        }

        // --- Helper function to update the highlight and sheet ---
        function updateHighlight(newlyHighlightedItem) {
            sortableList.querySelectorAll('li').forEach(item => {
                item.classList.remove('highlighted');
            });
            if (newlyHighlightedItem) {
                newlyHighlightedItem.classList.add('highlighted');
                populateCharacterSheet(newlyHighlightedItem);
                highlightedIndex = Array.from(sortableList.children).indexOf(newlyHighlightedItem);
            } else {
                clearCharacterSheet();
                highlightedIndex = -1;
            }
            saveState();
        }

        // --- Function to Save the Current State to localStorage ---
        function saveState() {
            const items = [];
            sortableList.querySelectorAll('li').forEach(listItem => {
                const name = listItem.querySelector('.item-text').textContent;
                const initiative = listItem.querySelector('.initiative-score').textContent;
                const currentHp = listItem.getAttribute('data-current-hp');
                const maxHp = listItem.getAttribute('data-max-hp');
                const ac = listItem.getAttribute('data-ac');
                const speed = listItem.getAttribute('data-speed');
                const notes = listItem.getAttribute('data-notes');
                const status = listItem.getAttribute('data-status');
                const locked = listItem.classList.contains('locked');
                items.push({ name: name, initiative: initiative, currentHp: currentHp, maxHp: maxHp, ac: ac, speed: speed, notes: notes, status: status, locked: locked });
            });
            localStorage.setItem('rpgEncounterList', JSON.stringify(items));
            localStorage.setItem('rpgEncounterRound', currentRound);
            localStorage.setItem('rpgEncounterHighlightedIndex', highlightedIndex);
            console.log('List state, round, and highlight saved.');
        }

        // --- Function to Load the State from localStorage ---
        function loadState() {
            const savedList = localStorage.getItem('rpgEncounterList');
            const savedRound = localStorage.getItem('rpgEncounterRound');
            const savedHighlightedIndex = localStorage.getItem('rpgEncounterHighlightedIndex');

            sortableList.innerHTML = '';

            if (savedList) {
                const items = JSON.parse(savedList);
                items.forEach(item => {
                    const statusObj = item.status ? JSON.parse(item.status) : null;
                    const listItem = createListItemElement(item.name, item.initiative, item.currentHp, item.maxHp, item.ac, item.speed, item.notes, statusObj, item.locked);
                    sortableList.appendChild(listItem);
                });
                console.log('List state loaded from localStorage.');
            } else {
                console.log('No saved list found.');
            }

            if (savedRound) {
                currentRound = parseInt(savedRound, 10);
            } else {
                currentRound = 1;
            }
            updateRoundCounter();

            if (savedHighlightedIndex !== null) {
                highlightedIndex = parseInt(savedHighlightedIndex, 10);
                const listItems = Array.from(sortableList.children);
                if (listItems[highlightedIndex]) {
                    updateHighlight(listItems[highlightedIndex]);
                } else {
                    highlightedIndex = -1;
                    updateHighlight(null);
                }
            } else {
                highlightedIndex = -1;
                updateHighlight(null);
            }

            if (highlight
